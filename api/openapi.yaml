openapi: 3.0.3
info:
  title: ATHYLPS Backend API
  description: |
    Backend API for ATHYLPS mobile application.

    ## Authentication
    Most endpoints require Bearer token authentication. Include the token in the Authorization header:
    ```
    Authorization: Bearer <your-token>
    ```
  version: 1.0.0
  contact:
    name: ATHYLPS Team
  license:
    name: Proprietary

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://athylps-api.tmphey.dev
    description: Production server

tags:
  - name: webhooks
    description: Webhook endpoints for third-party integrations

paths:
  /hooks/revenuecat:
    post:
      tags:
        - webhooks
      summary: RevenueCat webhook handler
      description: |
        Receives webhook events from RevenueCat for subscription and purchase events.
        This endpoint processes events such as subscription renewals, cancellations,
        billing issues, and initial purchases.

        **Security**: Requires Bearer token authentication to verify the request originates from RevenueCat.

        It will try to always respond success even in case of errors, so RC won't spam us with retries.
        Occasional 500 is possible.
      operationId: handleRevenueCatWebhook
      security:
        - bearerAuth: []
      requestBody:
        required: true
        description: RevenueCat webhook event payload
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RevenueCatWebhookEvent'
      responses:
        '200':
          description: Webhook successfully processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookResponse'
              example:
                status: success
                message: Webhook processed successfully
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Internal Server Error
                message: An unexpected error occurred

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Bearer token authentication. Provide your API token in the Authorization header.

        Example: `Authorization: Bearer <your-token>`

  schemas:
    RevenueCatWebhookEvent:
      type: object
      description: RevenueCat webhook event payload
      required:
        - event
      properties:
        event:
          type: object
          description: Event details
          required:
            - id
            - app_id
            - type
            - store
            - environment
          properties:
            id:
              type: string
              description: Unique identifier of the event
              example: "CD489E0E-5D52-4E03-966B-A7F17788E432"
            app_id: 
              type: string
              description: Unique identifier of the app the event is associated with. Corresponds to an app within a project
              example: "app115cdb5ecb"
            type:
              type: string
              description: Type of RevenueCat event
              example: "INITIAL_PURCHASE"
              enum:
                - TEST
                - INITIAL_PURCHASE
                - NON_RENEWING_PURCHASE
                - RENEWAL
                - PRODUCT_CHANGE
                - CANCELLATION
                - BILLING_ISSUE
                - SUBSCRIBER_ALIAS
                - SUBSCRIPTION_PAUSED
                - UNCANCELLATION
                - TRANSFER
                - SUBSCRIPTION_EXTENDED
                - EXPIRATION
                - TEMPORARY_ENTITLEMENT_GRANT
                - INVOICE_ISSUANCE
                - VIRTUAL_CURRENCY_TRANSACTION
                - EXPERIMENT_ENROLLMENT
            store:
              type: string
              description: Store where the purchase was made
              enum:
                - APP_STORE
                - PLAY_STORE
                - STRIPE
                - PROMOTIONAL
              example: "APP_STORE"
            environment:
              type: string
              description: Environment where the event occurred
              enum:
                - PRODUCTION
                - SANDBOX
              example: "PRODUCTION"
            app_user_id:
              type: string
              description: Unique identifier for the user in your app
              example: "$RCAnonymousID:992ed7dce7d442838082445dfb1bacbe"
            product_id:
              type: string
              description: Product/SKU identifier
              example: "premium_monthly"
            purchased_at_ms:
              type: integer
              format: int64
              description: Purchase timestamp in milliseconds
              example: 1699564800000
            cancelled_at_ms:
              type: integer
              format: int64
              description: Cancellation timestamp in milliseconds (for CANCELLATION events)
              example: 1699564800000
            country_code: 
              type: string
              description: Country code where the product was purchased
              x-nullable: true
            expiration_at_ms:
              type: integer
              format: int64
              description: Expiration timestamp in milliseconds
              example: 1702156800000
            price:
              type: number
              format: float
              description: Price in dollars
              example: 4.45
              x-nullable: true
            price_in_purchased_currency:
              type: number
              format: float
              description: Price in the currency used for purchase
              example: 9.99
              x-nullable: true
            currency:
              type: string
              description: ISO 4217 currency code
              example: "USD"
            period_type:
              type: string
              description: Period type of the transaction
              example: "TRIAL"
              enum:
                - TRIAL
                - INTRO
                - NORMAL
                - PROMOTIONAL
                - PREPAID
            renewal_number:
              type: integer
              description: The number of renewals that this subscription has already gone through. Always starts at 1
              example: "2"
              x-nullable: true

    WebhookResponse:
      type: object
      description: Successful webhook response
      required:
        - status
      properties:
        status:
          type: string
          description: Status of the webhook processing
          enum:
            - success
          example: success
        message:
          type: string
          description: Human-readable message
          example: Webhook processed successfully

    ErrorResponse:
      type: object
      description: Error response structure
      required:
        - error
      properties:
        error:
          type: string
          description: Error type or code
          example: Bad Request
        message:
          type: string
          description: Human-readable error message
          example: Invalid request payload
        details:
          type: object
          description: Additional error details
          additionalProperties: true
