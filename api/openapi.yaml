openapi: 3.0.3
info:
  title: ATHYLPS Backend API
  description: |
    Backend API for ATHYLPS mobile application.

    ## Authentication
    Most endpoints require Bearer token authentication. Include the token in the Authorization header:
    ```
    Authorization: Bearer <your-token>
    ```
  version: 1.0.0
  contact:
    name: ATHYLPS Team
  license:
    name: Proprietary

servers:
  - url: http://localhost:8080
    description: Local development server
  - url: https://athylps-api.tmphey.dev
    description: Production server

tags:
  - name: webhooks
    description: Webhook endpoints for third-party integrations

paths:
  /hooks/revenuecat:
    post:
      tags:
        - webhooks
      summary: RevenueCat webhook handler
      description: |
        Receives webhook events from RevenueCat for subscription and purchase events.
        This endpoint processes events such as subscription renewals, cancellations,
        billing issues, and initial purchases.

        **Security**: Requires Bearer token authentication to verify the request originates from RevenueCat.
      operationId: handleRevenueCatWebhook
      security:
        - bearerAuth: []
      requestBody:
        required: true
        description: RevenueCat webhook event payload
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/RevenueCatWebhookEvent'
            examples:
              initialPurchase:
                summary: Initial Purchase Event
                value:
                  event:
                    type: INITIAL_PURCHASE
                    app_user_id: "user123"
                    product_id: "premium_monthly"
                    purchased_at_ms: 1699564800000
                    store: "app_store"
                    environment: "PRODUCTION"
              renewal:
                summary: Renewal Event
                value:
                  event:
                    type: RENEWAL
                    app_user_id: "user123"
                    product_id: "premium_monthly"
                    purchased_at_ms: 1699564800000
                    store: "app_store"
                    environment: "PRODUCTION"
              cancellation:
                summary: Cancellation Event
                value:
                  event:
                    type: CANCELLATION
                    app_user_id: "user123"
                    product_id: "premium_monthly"
                    cancelled_at_ms: 1699564800000
                    store: "app_store"
                    environment: "PRODUCTION"
      responses:
        '200':
          description: Webhook successfully processed
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/WebhookResponse'
              example:
                status: success
                message: Webhook processed successfully
        '401':
          description: Unauthorized - Invalid or missing Bearer token
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Unauthorized
                message: Invalid or missing authorization token
        '400':
          description: Bad Request - Invalid webhook payload
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Bad Request
                message: Invalid webhook payload
        '500':
          description: Internal Server Error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
              example:
                error: Internal Server Error
                message: An unexpected error occurred

components:
  securitySchemes:
    bearerAuth:
      type: http
      scheme: bearer
      bearerFormat: JWT
      description: |
        Bearer token authentication. Provide your API token in the Authorization header.

        Example: `Authorization: Bearer <your-token>`

  schemas:
    RevenueCatWebhookEvent:
      type: object
      description: RevenueCat webhook event payload
      required:
        - event
      properties:
        event:
          type: object
          description: Event details
          required:
            - type
            - app_user_id
          properties:
            type:
              type: string
              description: Type of RevenueCat event
              enum:
                - INITIAL_PURCHASE
                - RENEWAL
                - CANCELLATION
                - UNCANCELLATION
                - NON_RENEWING_PURCHASE
                - SUBSCRIPTION_PAUSED
                - EXPIRATION
                - BILLING_ISSUE
                - PRODUCT_CHANGE
                - TRANSFER
              example: INITIAL_PURCHASE
            app_user_id:
              type: string
              description: Unique identifier for the user in your app
              example: "user123"
            product_id:
              type: string
              description: Product/SKU identifier
              example: "premium_monthly"
            purchased_at_ms:
              type: integer
              format: int64
              description: Purchase timestamp in milliseconds
              example: 1699564800000
            cancelled_at_ms:
              type: integer
              format: int64
              description: Cancellation timestamp in milliseconds (for CANCELLATION events)
              example: 1699564800000
            expiration_at_ms:
              type: integer
              format: int64
              description: Expiration timestamp in milliseconds
              example: 1702156800000
            store:
              type: string
              description: Store where the purchase was made
              enum:
                - app_store
                - play_store
                - stripe
                - promotional
              example: "app_store"
            environment:
              type: string
              description: Environment where the event occurred
              enum:
                - PRODUCTION
                - SANDBOX
              example: "PRODUCTION"
            price_in_purchased_currency:
              type: number
              format: float
              description: Price in the currency used for purchase
              example: 9.99
            currency:
              type: string
              description: ISO 4217 currency code
              example: "USD"
            is_trial_period:
              type: boolean
              description: Whether this is a trial period
              example: false

    WebhookResponse:
      type: object
      description: Successful webhook response
      required:
        - status
      properties:
        status:
          type: string
          description: Status of the webhook processing
          enum:
            - success
          example: success
        message:
          type: string
          description: Human-readable message
          example: Webhook processed successfully

    ErrorResponse:
      type: object
      description: Error response structure
      required:
        - error
      properties:
        error:
          type: string
          description: Error type or code
          example: Bad Request
        message:
          type: string
          description: Human-readable error message
          example: Invalid request payload
        details:
          type: object
          description: Additional error details
          additionalProperties: true
